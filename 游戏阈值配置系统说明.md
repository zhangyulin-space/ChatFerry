# 游戏阈值配置系统说明

## 概述

为了消除硬编码的阈值问题，我们创建了一个统一的配置管理系统，将所有游戏阈值集中在一个配置文件中，便于维护和调整。

## 核心文件

### 1. `src/game/config/gameThresholds.ts`
**主要配置文件**，包含所有游戏阈值和评估范围的定义。

### 2. `src/game/config/ConfigManager.ts`
**配置管理器**，负责配置的初始化、验证和管理。

### 3. `src/game/config/chapterConfig.ts`
**章节配置**，使用统一配置系统的章节转换逻辑。

## 配置结构

### 评估范围配置
```typescript
export const CHAPTER_EVALUATION_RANGES: Record<Chapter, EvaluationRanges> = {
  'fog-city': {
    trustLevel: { min: -15, max: 15 },
    awakeningLevel: { min: 0, max: 12 }
  },
  'mirror-desert': {
    trustLevel: { min: -15, max: 15 },
    awakeningLevel: { min: 0, max: 12 }
  },
  'mechanical-dream': {
    trustLevel: { min: -15, max: 15 },
    awakeningLevel: { min: 0, max: 12 }
  },
  'awakening': {
    trustLevel: { min: -20, max: 20 },
    awakeningLevel: { min: 0, max: 15 }
  }
}
```

### 章节转换阈值配置
```typescript
export const CHAPTER_TRANSITION_THRESHOLDS: Record<Chapter, ChapterTransitionThreshold> = {
  'fog-city': { trustLevel: 10, awakeningLevel: 8 },
  'mirror-desert': { trustLevel: 12, awakeningLevel: 9 },
  'mechanical-dream': { trustLevel: 14, awakeningLevel: 10 },
  'awakening': { trustLevel: 15, awakeningLevel: 12 }
}
```

### 章节总结阈值配置
```typescript
export const CHAPTER_SUMMARY_THRESHOLDS: Record<Chapter, ChapterSummaryThreshold> = {
  'fog-city': { trustLevel: 10, awakeningLevel: 8 },
  'mirror-desert': { trustLevel: 12, awakeningLevel: 9 },
  'mechanical-dream': { trustLevel: 14, awakeningLevel: 10 },
  'awakening': { trustLevel: 15, awakeningLevel: 12 }
}
```

### 游戏结束阈值配置
```typescript
export const GAME_ENDING_THRESHOLD: EndingThreshold = {
  trustLevel: 15,
  awakeningLevel: 12
}
```

## 工具函数

### 1. 配置获取函数
- `getChapterEvaluationRanges(chapter)`: 获取章节评估范围
- `getChapterTransitionThreshold(chapter)`: 获取章节转换阈值
- `getChapterSummaryThreshold(chapter)`: 获取章节总结阈值

### 2. 条件检查函数
- `checkChapterTransitionCondition(chapter, trustLevel, awakeningLevel)`: 检查章节转换条件
- `checkChapterSummaryCondition(chapter, trustLevel, awakeningLevel)`: 检查章节总结条件
- `checkGameEndingCondition(chapter, trustLevel, awakeningLevel)`: 检查游戏结束条件

### 3. 状态验证函数
- `validateAndClampStateValues(chapter, trustLevel, awakeningLevel)`: 验证并限制状态值
- `getControllerEvaluationPrompt(chapter)`: 获取控制器评估提示

### 4. 配置管理函数
- `validateConfiguration()`: 验证配置有效性
- `getConfigurationInfo()`: 获取配置信息

## 使用方法

### 1. 初始化配置
```typescript
import { ConfigManager } from '../config/ConfigManager'

// 在游戏启动时初始化
ConfigManager.initialize()
```

### 2. 检查条件
```typescript
import { checkChapterTransitionCondition } from '../config/gameThresholds'

// 检查是否满足章节转换条件
const canTransition = checkChapterTransitionCondition(
  currentChapter, 
  trustLevel, 
  awakeningLevel
)
```

### 3. 验证状态值
```typescript
import { validateAndClampStateValues } from '../config/gameThresholds'

// 验证并限制状态值在有效范围内
const { trustLevel: newTrust, awakeningLevel: newAwakening } = validateAndClampStateValues(
  currentChapter,
  currentTrust + trustChange,
  currentAwakening + awakeningChange
)
```

### 4. 获取评估提示
```typescript
import { getControllerEvaluationPrompt } from '../config/gameThresholds'

// 获取当前章节的评估提示
const prompt = getControllerEvaluationPrompt(currentChapter)
```

## 配置调整

### 修改评估范围
要调整某个章节的评估范围，只需修改 `CHAPTER_EVALUATION_RANGES` 中的相应配置：

```typescript
// 例如：调整迷雾城的信任度范围
'fog-city': {
  trustLevel: { min: -20, max: 20 },  // 从 -15~15 改为 -20~20
  awakeningLevel: { min: 0, max: 12 }
}
```

### 修改转换阈值
要调整章节转换的难度，修改 `CHAPTER_TRANSITION_THRESHOLDS`：

```typescript
// 例如：提高迷雾城到镜像沙漠的转换难度
'fog-city': {
  trustLevel: 15,    // 从 10 提高到 15
  awakeningLevel: 10 // 从 8 提高到 10
}
```

### 修改总结阈值
要调整章节总结的触发条件，修改 `CHAPTER_SUMMARY_THRESHOLDS`：

```typescript
// 例如：降低觉醒章节的总结触发条件
'awakening': {
  trustLevel: 12,    // 从 15 降低到 12
  awakeningLevel: 10 // 从 12 降低到 10
}
```

## 配置验证

系统会自动验证配置的有效性：

1. **完整性检查**：确保所有章节都有配置
2. **合理性检查**：确保阈值不超出评估范围
3. **一致性检查**：确保相关配置之间的一致性

### 验证输出示例
```
验证游戏阈值配置...
游戏阈值配置信息:

fog-city:
  评估范围: 信任度 -15~15, 觉醒值 0~12
  转换阈值: 信任度 10, 觉醒值 8
  总结阈值: 信任度 10, 觉醒值 8

mirror-desert:
  评估范围: 信任度 -15~15, 觉醒值 0~12
  转换阈值: 信任度 12, 觉醒值 9
  总结阈值: 信任度 12, 觉醒值 9

mechanical-dream:
  评估范围: 信任度 -15~15, 觉醒值 0~12
  转换阈值: 信任度 14, 觉醒值 10
  总结阈值: 信任度 14, 觉醒值 10

awakening:
  评估范围: 信任度 -20~20, 觉醒值 0~15
  转换阈值: 信任度 15, 觉醒值 12
  总结阈值: 信任度 15, 觉醒值 12

游戏结束阈值: 信任度 15, 觉醒值 12
游戏阈值配置验证完成
```

## 优势

### 1. 集中管理
- 所有阈值配置集中在一个文件中
- 便于查找和修改
- 减少配置分散的问题

### 2. 类型安全
- 使用 TypeScript 接口定义配置结构
- 编译时检查配置错误
- 提供智能提示和自动补全

### 3. 易于维护
- 修改配置只需更新一个文件
- 自动验证配置有效性
- 提供详细的配置信息输出

### 4. 扩展性强
- 易于添加新的配置项
- 支持运行时配置更新
- 便于添加新的验证规则

### 5. 调试友好
- 详细的配置信息输出
- 配置验证错误提示
- 便于问题定位和解决

## 迁移说明

所有硬编码的阈值已经被替换为配置系统：

### 已迁移的文件
- ✅ `src/game/config/chapterConfig.ts`
- ✅ `src/game/controllers/GameController.ts`
- ✅ `src/game/controllers/ChapterSummaryController.ts`
- ✅ `src/game/controllers/DialogResponseController.ts`
- ✅ `src/game/agents/AgentManager.ts`

### 迁移效果
- 消除了所有硬编码的阈值
- 统一了配置管理方式
- 提高了代码的可维护性
- 增强了系统的灵活性

现在所有的游戏阈值都可以通过修改 `gameThresholds.ts` 文件来统一调整，大大提高了系统的可维护性和灵活性。 